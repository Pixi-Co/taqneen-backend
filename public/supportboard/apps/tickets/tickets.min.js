"use strict";!function(e){function t(){e(l).addClass("sb-collapsing"),setTimeout(function(){e(l).removeClass("sb-collapsing")},1e3)}function s(e){if(void 0===e)return window.sb_current_user;window.sb_current_user=e}function i(e){return SBF.translate(e)}function n(){0!=s()&&e(p).setProfile("#"==s().get("last_name").charAt(0)?i("Account"):s().name)}function a(e=!1){let t="";o((t=e&&"title"in e.details&&!SBF.null(e.details.title)?e.get("title"):SBF.setting("tickets-conversation-name"))&&-1!=t?t:s().name)}function o(t){e(v).html(t).sbActive(t)}var l,r,c,d,b,f,g,v,u,p,m,h={},S={},B=e(window).width()<426,w={showPanel:function(t="",s=!1){let n=f;switch(f=t,e(l).addClass("sb-panel-active sb-load").removeClass("sb-panel-form").attr("data-panel",t),t){case"privacy":SBF.ajax({function:"get-block-setting",value:"privacy"},t=>{o(i(t.title)),e(d).append(`<div class="sb-privacy sb-init-form" data-decline="${i(t.decline.replace(/"/g,""))}"><div class="sb-text">${i(t.message)}</div>`+(""!=t.link?`<a target="_blank" href="${t.link}">${i(t["link-name"])}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${i(t["btn-approve"])}</a><a class="sb-btn sb-decline">${i(t["btn-decline"])}</a></div></div>`)}),this.showSidePanels(!1);break;case"articles":o(i(0==s?"Articles":s)),this.showSidePanels(!1);break;case"edit-profile":case"login":case"registration":let v="edit-profile"==t;this.showSidePanels(!1),e(l).addClass("sb-panel-form"),t in S?(e(d).html(S[t]),o(i(e(d).find(".sb-top").html()))):(SBF.ajax({function:"get-rich-message",name:(v?"registration":t)+"-tickets"},s=>{e(d).html(s);let n=e(d).find(".sb-top").html();v&&e(d).find(".sb-top").html(i("Edit profile")),o(i(n)),setTimeout(function(){o(i(n))},300),e(d).find(".sb-link-area").insertAfter(".sb-buttons"),e(d).find(".sb-info").insertBefore(".sb-buttons"),S[t]=e(d).html()}),e(d).html('<div class="sb-loading"></div>'));break;case"new-ticket":let u={title:"Title",message:"Message",panel:"Create a new ticket",button:"Create a new ticket"};if(this.showSidePanels(!1),SBF.setting("tickets-names")){let e=SBF.setting("tickets-names");for(var g in e)e[g]&&(u[g.replace("tickets-names-","")]=e[g])}o(i(u.panel)),e(d).html(`<div class="sb-info"></div><div class="sb-input sb-input-text sb-ticket-title"><span>${i(u.title)}</span><input type="text" required></div>${e(l).find(".sb-ticket-fields").html()}<div class="sb-input sb-editor-cnt"><span>${i(u.message)}</span></div><div class="sb-btn sb-icon sb-create-ticket"><i class="sb-icon-plus"></i>${i(u.button)}</div>`),e(r).find(".sb-editor-cnt").append(b);break;default:this.showSidePanels(!0),"new-ticket"==n&&(e(b).removeClass("sb-error"),e(b).find("textarea").val(""),e(b).find(".sb-bar").sbActive(!1),e(c).after(b)),e(d).html(""),e(l).removeClass("sb-panel-active sb-load").removeAttr("data-panel"),a(SBChat.conversation)}SBF.event("SBPanelActive",t),setTimeout(function(){e(l).removeClass("sb-load")},300)},showSidePanels:function(s=!0){let i=e(l).find(".sb-btn-collapse");t(),!s||m>800?e(l).find(".sb-panel-left,.sb-panel-right").setClass("sb-collapsed",!s):m<=800&&e(i).sbActive(!0),e(i).css("display",s?"":"none")},setAgent:function(t){let s=e(l).find(".sb-agent-label").sbActive(!1);if(SBChat.agent_id=t,t in h){let i=h[t];e(u).setProfile(i.name,i.image).sbActive(!0),"details"in i&&SBF.getLocationTimeString(i.extra,t=>{e(s).html((""!=i.get("flag")?`<img src="${SB_URL}/media/flags/${i.get("flag")}">`:'<i class="sb-icon sb-icon-marker"></i>')+t).sbActive(!0)})}else SBF.ajax({function:"get-agent",agent_id:t},e=>{0!=e&&(h[t]=new SBUser(e),this.setAgent(t))})},activateConversation:function(t){if(t instanceof SBConversation){let n=SBChat.lastAgent(),o=["id","creation_time","last_update"],r="";this.selectConversation(t.id),a(t),e(l).find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),n?(e(u).setProfile(n.full_name,n.profile_image),this.setAgent(n.user_id),setTimeout(function(){SBChat.updateUsersActivity()},300)):e(u).sbActive(!1),""!=t.get("department")&&SBChat.getDepartmentCode(t.get("department"),t=>{let s=e(l).find(".sb-department");e(s).html(`<span class="sb-title">${e(s).data("label")}</span>${t}`).sbActive(!0)});for(s=0;s<o.length;s++){let e;switch(o[s]){case"id":e=["padlock",i("Ticket ID"),t.id];break;case"creation_time":e=["calendar",i("Creation time"),SBF.beautifyTime(t.get("creation_time"),!0)];break;case"last_update":e=["reload",i("Last update"),SBF.beautifyTime(0==t.getLastMessage()?t.get("creation_time"):t.getLastMessage().get("creation_time"),!0)]}r+=`<div data-id="${o[s]}"><i class="sb-icon sb-icon-${e[0]}"></i><span>${e[1]}</span><div>${e[2]}</div></div>`}e(l).find(".sb-ticket-details").html(r);let d=t.getAttachments();r="";for(var s=0;s<d.length;s++)r+=`<a href="${d[s][1]}" target="_blank"><i class="sb-icon sb-icon-file"></i>${d[s][0]}</a>`;e(l).find(".sb-conversation-attachments").html((""==r?"":`<div class="sb-title">${i("Attachments")}</div>`)+r),e(c).sbLoading(!1)}else SBF.error("Value not of type SBConversation","activateConversation")},selectConversation:function(t){let s=e(g).find(`[data-conversation-id="${t}"]`);e(g).find("> li").sbActive(!1),1==e(s).attr("data-conversation-status")&&e(s).attr("data-conversation-status",0),e(s).sbActive(!0)},getActiveConversation:function(t=""){let s=e(g).find(" > .sb-active");return!!s.length&&("ID"==t?e(s).attr("data-conversation-id"):s)},welcome:function(){SBF.setting("tickets-welcome-active")&&!SBF.storage("tickets-welcome")&&setTimeout(()=>{SBChat.sendMessage(SBF.setting("bot-id"),SBF.setting("tickets-welcome-message")),SBF.storage("tickets-welcome",!0)},1e3)},init:function(){if(l=e("body").find(".sb-tickets"),r=e(l).find(" > div > .sb-panel-main"),d=e(r).find(".sb-panel"),b=e(r).find(".sb-editor"),v=e(r).find(" > .sb-top .sb-title"),g=e(l).find(".sb-user-conversations"),c=e(r).find(".sb-list"),u=e(l).find(".sb-profile-agent"),p=e(l).find(".sb-panel-right > .sb-top .sb-profile"),m=e(l).width(),e(l).on("click",".sb-btn-collapse",function(){t(),e(l).find(".sb-panel-"+(e(this).hasClass("sb-left")?"left":"right")).toggleClass("sb-collapsed"),e(this).toggleClass("sb-active")}),e(b).on("focus focusout","textarea",function(){e(this).parent().parent().toggleClass("sb-focus")}),B||(e(b).on("click",".sb-btn-emoji",function(){let t="new-ticket"==f?[d,"padding-top",415]:[l,"margin-top",335];if(e(b).find(".sb-emoji").sbActive()){let s=e(this).offset().top+e(t[0])[0].scrollTop-window.scrollY,i=e(l).offset().top-window.scrollY;s-i<380&&e(t[0]).css(t[1],t[2]-(s-i)+"px")}else e(t[0]).css(t[1],"")}),e(b).on("click",".sb-emoji-list > ul > li",function(){let t="new-ticket"==f?[d,"padding-top",415]:[l,"margin-top",335];e(t[0]).css(t[1],"")})),e(r).on("click","> .sb-top .sb-close",function(){w.showPanel()}),e(r).on("click",".sb-create-ticket",function(){let t=!1;if(e(b).removeClass("sb-error"),SBForm.errors(d)&&(SBForm.showErrorMessage(d,"Please fill in all the required fields."),t=!0),e(b).find("textarea").val().trim()||(t||SBForm.showErrorMessage(d,"Please write a message."),e(b).addClass("sb-error"),t=!0),!t&&!SBChat.is_busy){let t="",a=SBForm.getAll(d),o="department"in a?a.department[0]:null,l=[];SBChat.clear(),SBChat.activateBar(!1);for(var n in a)a[n][1]&&a[n][0]&&(t+=`*${i(a[n][1])}*\n${"department"==n?d.find("#department li.sb-active").html():a[n][0]}\n\n`);t+=e(b).find("textarea").val().trim(),d.find(".sb-attachments > div").each(function(){l.push([e(this).attr("data-name"),e(this).attr("data-value")])}),s()?SBChat.newConversation(2,-1,t,l,o,null,function(){w.welcome()}):SBChat.addUserAndLogin(()=>{SBChat.newConversation(2,-1,t,l,o,null,function(){w.welcome()})})}}),e(l).on("click",".sb-new-ticket",function(){w.showPanel("new-ticket")}),e(g).on("click","li",function(){SBChat.clear(),w.selectConversation(e(this).attr("data-conversation-id")),e(c).sbLoading(!0),B&&e(l).find(".sb-panel-left").addClass("sb-collapsed")}),e(l).find(".sb-panel-left .sb-search-btn input").on("input",function(){let t=e(this).val();SBF.search(t,()=>{t.length>1?SBF.ajax({function:"search-user-conversations",search:t},t=>{let n=[],a=t.length;for(var o=0;o<a;o++)n.push(new SBConversation([new SBMessage(t[o])],{id:t[o].conversation_id,title:t[o].title,conversation_status_code:t[o].conversation_status_code}));e(g).html(a?s().getConversationsCode(n):i("No results found."))}):SBChat.populateConversations()})}),e(l).on("click",".sb-panel-left .sb-search-btn i",function(){SBF.searchClear(this,()=>{SBChat.populateConversations()})}),e(d).on("click",".sb-login-area",function(){w.showPanel("login")}),e(d).on("click",".sb-registration-area",function(){w.showPanel("registration")}),e(l).on("click",'.sb-profile-menu [data-value="edit-profile"]',function(){w.showPanel("edit-profile")}),e(l).on("click",'.sb-profile-menu [data-value="logout"]',function(){SBF.logout(!1),w.showPanel("login")}),e(d).on("click","> .sb-buttons .sb-submit",function(){if(!e(this).sbLoading()){let t=SBForm.getAll(d),i=SBForm.getAll(d.find(".sb-form-extra")),a="edit-profile"==f;SBForm.errors(d)?SBForm.showErrorMessage(d,SBForm.getRegistrationErrorMessage(d)):(e(this).sbLoading(!0),t.user_type=["user",""],SBF.ajax({function:a||s()?"update-user":"add-user-and-login",settings:t,settings_extra:i},o=>{if(o&&!SBF.errorValidation(o)){if(SBF.loginCookie(o[1]),s()){for(var l in t)s().set(l,t[l][0]);for(var l in i)s().setExtra(l,i[l][0])}else{s(new SBUser(o[0]));for(var l in i)s().setExtra(l,i[l][0]);SBPusher.start(),SBChat.initChat()}n(),a?w.showPanel():(SBF.event("SBRegistrationForm",{user:t}),SBF.event("SBNewEmailAddress",{name:s().name,email:s().get("email")}),w.showPanel("new-ticket")),SBF.setting("wp-registration")&&"email"in t&&"password"in t?(console.log(t),SBApps.wordpress.ajax("wp-registration",{user_id:o[0].id,first_name:o[0].first_name,last_name:o[0].last_name,password:t.password[0],email:t.email[0]})):"wp"==SBF.setting("wp-users-system")&&SBApps.wordpress.ajax("wp-login",{user:t.email[0],password:t.password[0]})}else SBForm.showErrorMessage(d,SBForm.getRegistrationErrorMessage(o,"response"));e(this).sbLoading(!1)}))}}),e(d).on("click",".sb-submit-login",function(){SBF.loginForm(this,d,t=>{s(new SBUser(t[0])),n(),SBChat.populateConversations(t=>{0==t.length?(e(l).addClass("sb-no-conversations"),w.showPanel("new-ticket")):(SBChat.openConversation(t[0].id),w.showPanel())})})}),!l.length)return;if(!SBF.setting("tickets-registration-required")||s()&&!["visitor","lead"].includes(s().type))SBF.setting("welcome")||s()&&0!=s().conversations?s().conversations.length&&!w.getActiveConversation()?SBChat.openConversation(SBF.getURL("conversation")?SBF.getURL("conversation"):s().conversations[0].id):SBF.setting("welcome")&&a():(e(l).addClass("sb-no-conversations"),SBF.setting("privacy")&&!SBF.storage("privacy-approved")?w.showPanel("privacy"):SBF.setting("tickets-disable-first")||w.showPanel("new-ticket"));else{let t=SBF.setting("tickets-registration-redirect");if(t)return void(document.location=t+(t.includes("?")?"&":"?")+"sb=true");e(l).addClass("sb-no-conversations"),w.showPanel(SBF.setting("tickets-default-form"))}let o=parseInt(SBF.null(e(l).data("height"))?e(window).height():e(l).data("height")),h=parseInt(SBF.null(e(l).data("offset"))?0:e(l).data("offset"));m<=800?(e(l).addClass("sb-800"),e(l).find(".sb-panel-left,.sb-panel-right").addClass("sb-collapsed"),e(l).find(".sb-btn-collapse").sbActive(!0)):m<=1e3?e(l).addClass("sb-1000"):m<=1300&&e(l).addClass("sb-1300"),n(),e(l).removeClass("sb-loading").find(".sb-tickets-area").attr("style",`height: ${o-h}px`),setTimeout(function(){e(l).removeClass("sb-load")},300),SBChat.startRealTime(),SBF.event("SBTicketsInit")},onMessageSent:function(){if("new-ticket"==f){let t=e(r).find(".sb-ticket-title input").val();SBChat.updateConversations(),e(l).find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),e(l).find(".sb-conversation-attachments,.sb-ticket-details").html(""),e(l).removeClass("sb-no-conversations"),w.showPanel(),o(t)}},onNewConversationReceived:function(e){if(e.id==SBChat.conversation.id&&(w.getActiveConversation("ID")!=e.id&&setTimeout(()=>{w.activateConversation(SBChat.conversation)},300),SBF.setting("tickets-email")&&s().get("email"))){let t=e.messages[0];SBF.ajax({function:"tickets-email",message:t.message,attachments:t.attachments})}},onNewMessageReceived:function(t){if(t instanceof SBMessage&&t.get("conversation_id")==SBChat.conversation.id){let s=SBChat.lastAgent(),i=SBChat.conversation.getCode(),n=w.getActiveConversation();n?e(n).html(i):e(g).append(`<li data-conversation-id="${SBChat.conversation.id}" class="sb-active">${i}</li>`).find(" > p").remove(),s&&SBF.isAgent(t.get("user_type"))&&s.id!=t.get("user_id")&&w.setAgent(t.get("user_id"))}}};window.SBTickets=w}(jQuery);